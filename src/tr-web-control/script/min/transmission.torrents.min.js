/*! transmission-web-control 2017-05-22 */

transmission.torrents={all:null,puased:null,downloading:null,actively:null,searchResult:null,error:null,warning:null,folders:{},status:{},count:0,totalSize:0,loadSimpleInfo:!1,activeTorrentCount:0,pausedTorrentCount:0,fields:{base:"id,name,status,hashString,totalSize,percentDone,addedDate,trackerStats,leftUntilDone,rateDownload,rateUpload,recheckProgress,rateDownload,rateUpload,peersGettingFromUs,peersSendingToUs,uploadRatio,uploadedEver,downloadedEver,downloadDir,error,errorString,doneDate,queuePosition",status:"id,status,percentDone,trackerStats,leftUntilDone,rateDownload,rateUpload,rateDownload,rateUpload,peersGettingFromUs,peersSendingToUs,uploadRatio,uploadedEver,downloadedEver,error,errorString,doneDate,queuePosition",config:"downloadLimit,downloadLimited,peer-limit,seedIdleLimit,seedIdleMode,seedRatioLimit,seedRatioMode,uploadLimit,uploadLimited"},datas:{},recently:null,removed:null,isRecentlyActive:!1,newIds:new Array,getallids:function(a,b,c){var d=this.fields.base;this.loadSimpleInfo&&this.all&&(d=this.fields.status);var e=d.split(",");$.isArray(c)&&$.unique($.merge(e,c));var arguments={fields:e};this.isRecentlyActive=!1,this.all&&void 0==b?(arguments.ids="recently-active",this.isRecentlyActive=!0):b&&(arguments.ids=b),this.all||(this.all={}),transmission.exec({method:"torrent-get",arguments:arguments},function(b){"success"==b.result?(transmission.torrents.newIds.length=0,transmission.torrents.loadSimpleInfo=!0,transmission.torrents.recently=b.arguments.torrents,transmission.torrents.removed=b.arguments.removed,transmission.torrents.splitid(),a&&a(b.arguments.torrents)):(transmission.torrents.datas=null,a&&a(null))})},splitid:function(){this.downloading=new Array,this.puased=new Array,this.actively=new Array,this.error=new Array,this.warning=new Array,transmission.downloadDirs=new Array;var a=transmission._status;this.status={},transmission.trackers={},this.totalSize=0,this.folders={},this.count=0;var b=new Base64;for(var c in this.recently){var d=this.recently[c];this.datas[d.id]=d}var e=new Array;for(var c in this.removed){var d=this.removed[c];e.push(d)}for(var c in this.datas){var d=this.datas[c];if(!d)return;if(-1!=$.inArray(d.id,e)&&e.length>0)this.all[d.id]&&(this.all[d.id]=null,delete this.all[d.id]),this.datas[c]=null,delete this.datas[c];else{this.isRecentlyActive&&!this.all[d.id]&&this.newIds.push(d.id),d=$.extend(this.all[d.id],d),0==d.uploadedEver&&0==d.downloadedEver&&(d.uploadRatio="∞"),d.infoIsLoading=!1;var f=this.status[d.status];switch(this.addTracker(d),f||(this.status[d.status]=new Array,f=this.status[d.status]),this.totalSize+=d.totalSize,d.rateDownload>0&&d.leftUntilDone>0?(d.remainingTime=getTotalTime(d.leftUntilDone/d.rateDownload*1e3),d.remainingTimeRaw=Math.floor(d.leftUntilDone/d.rateDownload*1e3)):0==d.rateDownload&&0==d.leftUntilDone&&0!=d.totalSize?(d.remainingTime=0,d.remainingTimeRaw=0):(d.remainingTime="∞",d.remainingTimeRaw=31536e8),f.push(d),0!=d.error&&this.error.push(d),(d.rateUpload>0||d.rateDownload>0)&&this.actively.push(d),d.status){case a.stopped:this.puased.push(d);break;case a.download:this.downloading.push(d)}if(this.all[d.id]=d,-1==$.inArray(d.downloadDir,transmission.downloadDirs)&&transmission.downloadDirs.push(d.downloadDir),transmission.options.getFolders&&d.downloadDir){var g=d.downloadDir.split("/"),h="folders-";for(var i in g){var j=g[i];if(""!=j){h+=b.encode(j);var k=this.folders[h];k||(k={count:0,torrents:new Array,size:0,nodeid:h}),k.torrents.push(d),k.count++,k.size+=d.totalSize,this.folders[h]=k}}}this.count++}}transmission.downloadDirs=transmission.downloadDirs.sort(),this.newIds.length>0&&this.getallids(null,this.newIds)},addTracker:function(a){var b=a.trackerStats,c=!1;if(a.leecherCount=0,a.seederCount=0,b.length>0){for(var d in b){var e=b[d],f=e.lastAnnounceResult.toLowerCase(),g=e.host.replace("http://","").replace("https://","").split(":")[0].split(".");-1!=$.inArray(g[0],"www,tracker".split(","))&&g.shift();var h=g.join("."),i="tracker-"+h.replace(/\./g,"-"),j=transmission.trackers[i];j||(transmission.trackers[i]={count:0,torrents:new Array,size:0,connected:!0},j=transmission.trackers[i]),j.name=h,j.nodeid=i,j.host=e.host,"success"!=f&&0!=e.announceState&&(c=!0,a.warning=e.lastAnnounceResult,"could not connect to tracker"==f&&(j.connected=!1)),j.torrents.push(a),j.count++,j.size+=a.totalSize,a.leecherCount+=e.leecherCount,a.seederCount+=e.seederCount}c&&(a.nextAnnounceTime?a.nextAnnounceTime>e.nextAnnounceTime&&(a.nextAnnounceTime=e.nextAnnounceTime):a.nextAnnounceTime=e.nextAnnounceTime,this.warning.push(a)),a.leecherCount<0&&(a.leecherCount=0),a.seederCount<0&&(a.seederCount=0),a.leecher=a.leecherCount+" ("+a.peersGettingFromUs+")",a.seeder=a.seederCount+" ("+a.peersSendingToUs+")"}},getPeers:function(a){transmission.exec({method:"torrent-get",arguments:{fields:"peers,peersFrom".split(","),ids:a}},function(a){console.log("data:",a)})},getMoreInfos:function(a,b,c){transmission.exec({method:"torrent-get",arguments:{fields:a.split(","),ids:b}},function(a){"success"==a.result?c&&c(a.arguments.torrents):c&&c(null)})},search:function(a,b){if(!a)return null;b||(b=this.all);var c=new Array;return $.each(b,function(d,e){-1!=b[d].name.toLowerCase().indexOf(a.toLowerCase())&&c.push(b[d])}),this.searchResult=c,c},getFiles:function(a,b){transmission.exec({method:"torrent-get",arguments:{fields:"files,fileStats".split(","),ids:a}},function(a){"success"==a.result?b&&b(a.arguments.torrents):b&&b(null)})},getConfig:function(a,b){this.getMoreInfos(this.fields.config,a,b)},getErrorIds:function(a,b){var c=new Array,d=new Date;1==b&&(d=d.getTime()/1e3);for(var e in this.error){var f=this.error[e];-1!=$.inArray(f.id,a)&&a.length>0||(1==b&&d<f.nextAnnounceTime||f.status!=transmission._status.stopped&&c.push(f.id))}for(var e in this.warning){var f=this.warning[e];-1!=$.inArray(f.id,a)&&a.length>0||(1==b&&d<f.nextAnnounceTime||c.push(f.id))}return c},searchAndReplaceTrackers:function(a,b,c){if(a&&b){var d={},e=0;for(var f in this.all){var g=this.all[f];if(!g)return;var h=g.trackerStats;for(var i in h){h[i].announce==a&&(d[i]||(d[i]={ids:new Array,tracker:b}),d[i].ids.push(g.id),e++)}}0==e&&c&&c(null,0);for(var f in d)transmission.exec({method:"torrent-set",arguments:{ids:d[f].ids,trackerReplace:[parseInt(f),d[f].tracker]}},function(a,b){"success"==a.result?c&&c(b,e):c&&c(null)},d[f].ids)}}};