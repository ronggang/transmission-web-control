transmission.torrents={all:null,puased:null,downloading:null,actively:null,searchResult:null,error:null,warning:null,folders:{},status:{},count:0,totalSize:0,loadSimpleInfo:false,activeTorrentCount:0,pausedTorrentCount:0,fields:{base:"id,name,status,hashString,totalSize,percentDone,addedDate,trackerStats,leftUntilDone,rateDownload,rateUpload,recheckProgress,rateDownload,rateUpload,peersGettingFromUs,peersSendingToUs,uploadRatio,uploadedEver,downloadedEver,downloadDir,error,errorString,doneDate,queuePosition",
status:"id,status,percentDone,trackerStats,leftUntilDone,rateDownload,rateUpload,rateDownload,rateUpload,peersGettingFromUs,peersSendingToUs,uploadRatio,uploadedEver,downloadedEver,error,errorString,doneDate,queuePosition",config:"downloadLimit,downloadLimited,peer-limit,seedIdleLimit,seedIdleMode,seedRatioLimit,seedRatioMode,uploadLimit,uploadLimited"},datas:{},recently:null,removed:null,isRecentlyActive:false,newIds:[],getallids:function(b,d,c){var a=this.fields.base;if(this.loadSimpleInfo&&this.all)a=
this.fields.status;a=a.split(",");$.isArray(c)&&$.unique($.merge(a,c));arguments={fields:a};this.isRecentlyActive=false;if(this.all&&d==undefined){arguments.ids="recently-active";this.isRecentlyActive=true}else if(d)arguments.ids=d;if(!this.all)this.all={};transmission.exec({method:"torrent-get",arguments:arguments},function(e){if(e.result=="success"){transmission.torrents.newIds.length=0;transmission.torrents.loadSimpleInfo=true;transmission.torrents.recently=e.arguments.torrents;transmission.torrents.removed=
e.arguments.removed;transmission.torrents.splitid();b&&b(e.arguments.torrents)}else{transmission.torrents.datas=null;b&&b(null)}})},splitid:function(){this.downloading=[];this.puased=[];this.actively=[];this.error=[];this.warning=[];transmission.downloadDirs=[];var b=transmission._status;this.status={};transmission.trackers={};this.totalSize=0;this.folders={};this.count=0;var d=new Base64,c;for(c in this.recently){var a=this.recently[c];this.datas[a.id]=a}var e=[];for(c in this.removed){a=this.removed[c];
e.push(a)}for(c in this.datas){a=this.datas[c];if(!a)return;if($.inArray(a.id,e)!=-1&&e.length>0){if(this.all[a.id]){this.all[a.id]=null;delete this.all[a.id]}this.datas[c]=null;delete this.datas[c]}else{this.isRecentlyActive&&!this.all[a.id]&&this.newIds.push(a.id);a=$.extend(this.all[a.id],a);if(a.uploadedEver==0&&a.downloadedEver==0)a.uploadRatio="∞";a.infoIsLoading=false;var f=this.status[a.status];this.addTracker(a);if(!f){this.status[a.status]=[];f=this.status[a.status]}this.totalSize+=a.totalSize;
if(a.rateDownload>0&&a.leftUntilDone>0){a.remainingTime=getTotalTime(a.leftUntilDone/a.rateDownload*1E3);a.remainingTimeRaw=Math.floor(a.leftUntilDone/a.rateDownload*1E3)}else if(a.rateDownload==0&&a.leftUntilDone==0&&a.totalSize!=0){a.remainingTime=0;a.remainingTimeRaw=0}else{a.remainingTime="∞";a.remainingTimeRaw=31536E8}f.push(a);a.error!=0&&this.error.push(a);if(a.rateUpload>0||a.rateDownload>0)this.actively.push(a);switch(a.status){case b.stopped:this.puased.push(a);break;case b.download:this.downloading.push(a)}this.all[a.id]=
a;$.inArray(a.downloadDir,transmission.downloadDirs)==-1&&transmission.downloadDirs.push(a.downloadDir);if(transmission.options.getFolders)if(a.downloadDir){f=a.downloadDir.split("/");var h="folders-",i;for(i in f){var g=f[i];if(g!=""){h+=d.encode(g);(g=this.folders[h])||(g={count:0,torrents:[],size:0,nodeid:h});g.torrents.push(a);g.count++;g.size+=a.totalSize;this.folders[h]=g}}}this.count++}}transmission.downloadDirs=transmission.downloadDirs.sort();this.newIds.length>0&&this.getallids(null,this.newIds)},
addTracker:function(b){var d=b.trackerStats,c=false;b.leecherCount=0;b.seederCount=0;if(d.length>0){for(var a in d){var e=d[a],f=e.lastAnnounceResult.toLowerCase(),h=e.host.replace("http://","").replace("https://","").split(":")[0].split(".");$.inArray(h[0],"www,tracker".split(","))!=-1&&h.shift();h=h.join(".");var i="tracker-"+h.replace(/\./g,"-"),g=transmission.trackers[i];if(!g){transmission.trackers[i]={count:0,torrents:[],size:0,connected:true};g=transmission.trackers[i]}g.name=h;g.nodeid=i;
g.host=e.host;if(!e.lastAnnounceSucceeded&&e.announceState!=transmission._trackerStatus.inactive){c=true;b.warning=e.lastAnnounceResult;if(f=="could not connect to tracker")g.connected=false}g.torrents.push(b);g.count++;g.size+=b.totalSize;b.leecherCount+=e.leecherCount;b.seederCount+=e.seederCount}if(c){if(b.nextAnnounceTime){if(b.nextAnnounceTime>e.nextAnnounceTime)b.nextAnnounceTime=e.nextAnnounceTime}else b.nextAnnounceTime=e.nextAnnounceTime;this.warning.push(b)}if(b.leecherCount<0)b.leecherCount=
0;if(b.seederCount<0)b.seederCount=0;b.leecher=b.leecherCount+" ("+b.peersGettingFromUs+")";b.seeder=b.seederCount+" ("+b.peersSendingToUs+")"}},getPeers:function(b){transmission.exec({method:"torrent-get",arguments:{fields:"peers,peersFrom".split(","),ids:b}},function(d){console.log("data:",d)})},getMoreInfos:function(b,d,c){transmission.exec({method:"torrent-get",arguments:{fields:b.split(","),ids:d}},function(a){if(a.result=="success")c&&c(a.arguments.torrents);else c&&c(null)})},search:function(b,
d){if(!b)return null;if(!d)d=this.all;var c=[];$.each(d,function(a){d[a].name.toLowerCase().indexOf(b.toLowerCase())!=-1&&c.push(d[a])});return this.searchResult=c},getFiles:function(b,d){transmission.exec({method:"torrent-get",arguments:{fields:"files,fileStats".split(","),ids:b}},function(c){if(c.result=="success")d&&d(c.arguments.torrents);else d&&d(null)})},getConfig:function(b,d){this.getMoreInfos(this.fields.config,b,d)},getErrorIds:function(b,d){var c=[],a=new Date;if(d==true)a=a.getTime()/
1E3;for(var e in this.error){var f=this.error[e];if(!($.inArray(f.id,b)!=-1&&b.length>0)){if(d==true)if(a<f.nextAnnounceTime)continue;f.status!=transmission._status.stopped&&c.push(f.id)}}for(e in this.warning){f=this.warning[e];if(!($.inArray(f.id,b)!=-1&&b.length>0)){if(d==true)if(a<f.nextAnnounceTime)continue;c.push(f.id)}}return c},searchAndReplaceTrackers:function(b,d,c){if(b&&d){var a={},e=0,f;for(f in this.all){var h=this.all[f];if(!h)return;var i=h.trackerStats,g;for(g in i)if(i[g].announce==
b){a[g]||(a[g]={ids:[],tracker:d});a[g].ids.push(h.id);e++}}e==0&&c&&c(null,0);for(f in a)transmission.exec({method:"torrent-set",arguments:{ids:a[f].ids,trackerReplace:[parseInt(f),a[f].tracker]}},function(j,k){if(j.result=="success")c&&c(k,e);else c&&c(null)},a[f].ids)}}};
